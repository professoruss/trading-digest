<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="refresh" content="60">
    <title>Russ Daily Trade Digest</title>
    <style type="text/css">
      p.main {
        font-family: verdana,arial,sans-serif;
        font-size:11px;
      }
      table.gridtable {
        font-family: verdana,arial,sans-serif;
        font-size:11px;
        color:#333333;
        border-width: 1px;
        border-color: #666666;
        border-collapse: collapse;
      }
      table.gridtable th {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #666666;
        background-color: #dedede;
      }
      table.gridtable td {
        border-width: 1px;
        padding: 8px;
        border-style: solid;
        border-color: #666666;
        background-color: #ffffff;
      }
    </style>
    <script>
      d = new Date();
      yyyy = d.getFullYear();//Get the year as a four digit number (yyyy)
      mm = String(d.getMonth() + 1).padStart(2, '0');//Get the month as a number (01-12) - Jan is 0!
      dd = String(d.getDate()).padStart(2, '0');//Get the day as a number and pad(01-31)
      dayOfWeek = d.getDay();
      isWeekend = (dayOfWeek === 6) || (dayOfWeek  === 0); // 6 = Saturday, 0 = Sunday

      // figure out the weekdays this week
      if ( dayOfWeek === 6 ){ //saturday
        theseWeekdays = new Array ( dd - 1, dd - 2, dd - 3, dd - 4, dd - 5 );
      } else if ( dayOfWeek === 0 ){ // sunday
        theseWeekdays = new Array ( dd - 2, dd - 3, dd - 4, dd - 5, dd - 6 );
      } else if ( dayOfWeek === 1 ){ // monday
        theseWeekdays = new Array ( dd );
      } else if ( dayOfWeek === 2 ){ // tuesday
        theseWeekdays = new Array ( dd , dd - 1 );
      } else if ( dayOfWeek === 3 ){ // wednesday
        theseWeekdays = new Array ( dd , dd - 1, dd - 2 );
      } else if ( dayOfWeek === 4 ){ // thursday
        theseWeekdays = new Array ( dd , dd - 1, dd - 2, dd - 3 );
      } else if ( dayOfWeek === 5 ){ // friday
        theseWeekdays = new Array ( dd , dd - 1, dd - 2, dd - 3, dd - 4 );
      }

      dayTrades = 0;
      weekTrades = 0;
      totalProfit = 0;
      dayProfit = 0;
      weekProfit = 0;

      function getTrades(yr, mo, day){
        fetch("/trades/" + yr + "/" + mo + "/" + yr + mo + day + "-trades.txt")
          .then((response) => {
            if (response.status === 404) {
                    document.getElementById('mktClosed').innerHTML = "Market closed, Russ still sleeping, or hasn't found a trade yet <p><img width='40%' src='/images/moneysleep.jpg'>";
            } else {
              return response.text();
            }
          } )
          .then((text) => {
            var lines = text.split('\n');
            linesLengthAdj = String(lines.length - 1)
            if ( day === dd || isWeekend === true){
              for(var line = 0; line < linesLengthAdj; line++){
                var tradeTable = document.getElementById('tTable');
                var row = tradeTable.insertRow(tradeTable.rows.length);
                var cells = lines[line].split(/\s+/);
                cells.reverse()
                for(var cell = 0; cell < cells.length; cell++){
                  var cell1 = row.insertCell(0);
                  cell1.innerHTML = cells[cell];
                }
              }
            }
            dayTrades = parseInt(linesLengthAdj);
            weekTrades += parseInt(linesLengthAdj);
            document.getElementById('dTrades').innerHTML = "<b>Total Daily Trades: " + dayTrades;
            document.getElementById('wTrades').innerHTML = "<b>Total Weekly Trades: " + weekTrades;
          })
      }

      function getPl(yr, mo, day){
        fetch("/trades/" + yr + "/" + mo + "/" + yr + mo + day + "-pl.txt")
          .then((response) => {
            if (response.status === 404) {
              totalProfit = 0.0;
              return totalProfit;
            } else {
              return response.text();
            }
          })
         .then((text) => {
            totalProfit += parseFloat(text);
            dayProfit = parseFloat(text);
            weekProfit += parseFloat(text);
            document.getElementById('dPl').innerHTML = "<b>Day Realized P/L: $" + dayProfit;
            document.getElementById('wPl').innerHTML = "<b>Week Realized P/L: $" + weekProfit;
          })
      }

      if (isWeekend === true){
        console.log('weekend');
        console.log(theseWeekdays);
        var weekTotTrades = 0;
        for (var i = 0; i < theseWeekdays.length; i++) {
          padDay = String(theseWeekdays[i]).padStart(2, '0');
          getTrades(yyyy, mm, padDay);
          getPl(yyyy, mm, padDay);
          console.log(padDay);
        }
      } else{
        console.log('weekday');
        theseWeekdays.reverse()
        for (var i = 0; i < theseWeekdays.length; i++) {
          padDay = String(theseWeekdays[i]).padStart(2, '0');
          getPl(yyyy, mm, padDay)
          getTrades(yyyy, mm, padDay)
          dayProfit = 0.0;
          dayTrades = 0;
        }
      }
      </script>
    </head>
  <body>
    <p class="main"><span id="dTrades"></span> | <span id="wTrades"></span>
    <p class="main"><span id="dPl"></span> | <span id="wPl"></span>
    <p class="main" id="mktClosed"></p>
    <table class="gridtable" id="tTable">
    </table>
  </body>
</html>
